<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nessaly's Group - Administrateur</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --teal: #22c55e;
      --blue: #38bdf8;
      --bg: #050914;
      --glass: rgba(255,255,255,0.04);
      --border: rgba(255,255,255,0.08);
      --text: #e2e8f0;
      --muted: #94a3b8;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Manrope', system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(34,197,94,0.12), transparent 22%),
                  radial-gradient(circle at 80% 0%, rgba(56,189,248,0.10), transparent 20%),
                  #050914;
      color: var(--text);
      display: flex;
      flex-direction: column;
    }
    a { color: inherit; text-decoration: none; }
    .glass {
      background: var(--glass);
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 50px rgba(0,0,0,0.35);
    }
    .header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 72px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }
    .btn {
      border: none;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary {
      background: linear-gradient(135deg, var(--teal), var(--blue));
      color: #041015;
      box-shadow: 0 10px 30px rgba(56,189,248,0.25);
    }
    .layout {
      max-width: 1200px;
      margin: 100px auto 50px auto;
      padding: 0 20px;
      width: 100%;
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 20px;
    }
    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
    }
    .side {
      position: sticky;
      top: 90px;
      align-self: start;
    }
    .tabs button {
      width: 100%;
      text-align: left;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s ease;
    }
    .tabs button.active {
      background: rgba(34,197,94,0.1);
      border-color: rgba(34,197,94,0.3);
      color: var(--text);
    }
    .tabs button:hover { background: rgba(255,255,255,0.04); }
    .card {
      padding: 18px;
      border-radius: 16px;
    }
    .content { display: none; }
    .content.active { display: block; }
    .status-dot {
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--teal);
      box-shadow: 0 0 10px var(--teal);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      color: var(--muted);
      font-size: 14px;
    }
    th { color: var(--text); }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(34,197,94,0.1);
      color: var(--teal);
      font-size: 12px;
      font-weight: 700;
    }
    .danger { color: #f87171; background: rgba(248,113,113,0.1); }
  </style>
</head>
<body>
  <nav class="glass header">
    <div style="display:flex;align-items:center;gap:12px;">
      <div class="glass" style="width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:var(--teal);"><i class="fa-regular fa-building"></i></div>
      <div>
        <div style="font-weight:800;letter-spacing:0.04em;">Admin Nessaly's</div>
        <div style="font-size:12px;color:var(--muted);">Espace securise</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <div style="text-align:right;">
        <div id="admin-email" style="font-weight:700;">-</div>
        <div style="font-size:12px;color:var(--muted);">Connecte</div>
      </div>
      <button id="logout-btn" class="btn btn-primary"><i class="fa-solid fa-power-off"></i></button>
    </div>
  </nav>

  <div class="layout">
    <aside class="glass side card">
      <p style="margin:0 0 14px 0;color:var(--muted);font-size:13px;">Navigation</p>
      <div class="tabs" id="tabs">
        <button data-tab="dashboard" class="active"><i class="fa-solid fa-chart-line"></i> Dashboard</button>
        <button data-tab="companies"><i class="fa-solid fa-building"></i> Societes</button>
        <button data-tab="invoices"><i class="fa-solid fa-file-invoice"></i> Factures</button>
        <button data-tab="stats"><i class="fa-solid fa-chart-column"></i> Stats</button>
        <button data-tab="settings"><i class="fa-solid fa-gear"></i> Parametres</button>
      </div>
      <div style="margin-top:16px;padding:12px;border-radius:14px;background:rgba(34,197,94,0.08);color:var(--teal);font-weight:700;display:flex;align-items:center;gap:10px;">
        <span class="status-dot"></span> Session active
      </div>
    </aside>

    <section class="glass card">
      <div id="access-denied" class="content" style="display:none;">
        <h2 style="margin:0 0 10px 0;color:#f87171;">Acces refuse</h2>
        <p style="color:var(--muted);font-size:14px;">Votre compte n'est pas autorise pour l'espace admin. <a href="Accueil.html#admin-login" style="color:var(--teal);font-weight:700;">Revenir a l'accueil</a></p>
      </div>

      <div id="dashboard" class="content active">
        <h2 style="margin:0 0 10px 0;">Tableau de bord</h2>
        <p style="color:var(--muted);margin:0 0 16px 0;">Vue synthese</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
          <div class="glass card" style="padding:14px;border-radius:14px;">
            <p style="margin:0;color:var(--muted);font-size:13px;">Connexions</p>
            <h3 style="margin:6px 0 0 0;">Supabase Auth</h3>
            <span class="chip">Actif</span>
          </div>
          <div class="glass card" style="padding:14px;border-radius:14px;">
            <p style="margin:0;color:var(--muted);font-size:13px;">Role</p>
            <h3 id="role-label" style="margin:6px 0 0 0;">Admin</h3>
          </div>
        </div>
      </div>

      <div id="companies" class="content">
        <h2 style="margin:0 0 10px 0;">Societes</h2>
        <p style="color:var(--muted);margin:0 0 12px 0;">Liste a synchroniser depuis Supabase</p>
        <button id="admin-create-societe" class="btn btn-primary" style="margin-bottom:12px;display:inline-flex;align-items:center;gap:8px;"><i class="fa-solid fa-building"></i> Creer une societe</button>
        <div id="admin-societes-list" class="space-y-3">
          <div class="glass card" style="padding:12px;border-radius:14px;display:flex;align-items:center;gap:12px;">
            <span class="status-dot" style="width:8px;height:8px;background:var(--muted);box-shadow:none;"></span>
            <p style="margin:0;color:var(--muted);">Chargement des societes...</p>
          </div>
        </div>
      </div>

      <div id="invoices" class="content">
        <h2 style="margin:0 0 10px 0;">Factures</h2>
        <p style="color:var(--muted);margin:0 0 12px 0;">Synthese facturation</p>
        <table>
          <thead><tr><th>Ref</th><th>Client</th><th>Statut</th></tr></thead>
          <tbody>
            <tr><td colspan="3" style="text-align:center;color:var(--muted);">Aucune donnee</td></tr>
          </tbody>
        </table>
      </div>

      <div id="stats" class="content">
        <h2 style="margin:0 0 10px 0;">Stats</h2>
        <p style="color:var(--muted);margin:0;">Tableau de bord chiffré a connecter</p>
      </div>

      <div id="settings" class="content">
        <h2 style="margin:0 0 10px 0;">Parametres</h2>
        <p style="color:var(--muted);margin:0 0 12px 0;">Gestion du portail admin</p>
        <ul style="padding-left:16px;color:var(--muted);">
          <li>Connexion Supabase Auth</li>
          <li>Gestion des roles et acces</li>
          <li>Connexion aux donnees (a connecter)</li>
        </ul>
      </div>
    </section>
  </div>

  <div id="admin-societe-modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:100;">
    <div class="glass" style="width:90%;max-width:760px;border-radius:18px;padding:24px;max-height:92vh;overflow:auto;position:relative;">
      <button id="admin-close-societe" style="position:absolute;top:14px;right:14px;border:none;background:none;color:var(--muted);font-size:20px;cursor:pointer;">✕</button>
      <h3 style="margin:0 0 6px 0;">Creer une societe</h3>
      <p id="admin-soc-ref-label" style="margin:0 0 16px 0;font-family:monospace;color:var(--muted);">Ref: -</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
        <label>Nom*
          <input id="admin-soc-nom" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);">
        </label>
        <label>Référence
          <input id="admin-soc-ref" readonly class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--muted);background:rgba(255,255,255,0.04);">
        </label>
        <label>Logo
          <div style="margin-top:6px;display:flex;gap:12px;align-items:center;">
            <div id="admin-logo-preview" class="glass" style="width:60px;height:60px;border-radius:12px;border:1px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted);text-transform:uppercase;">Logo</div>
            <div style="flex:1;">
              <input id="admin-soc-logo-file" type="file" accept="image/*" class="glass" style="width:100%;padding:10px;border-radius:12px;border:1px dashed var(--border);color:var(--text);background:rgba(255,255,255,0.02);">
              <p style="margin:6px 0 0 0;font-size:12px;color:var(--muted);">PNG, JPG ou SVG - 2 Mo max.</p>
            </div>
          </div>
        </label>
        <label>SIRET
          <input id="admin-soc-siret" maxlength="18" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);">
          <small id="admin-siret-feedback" style="display:block;margin-top:4px;color:var(--muted);font-size:12px;"></small>
        </label>
        <label style="grid-column:1/-1;">Adresse
          <input id="admin-soc-adresse" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);">
        </label>
        <label>Email
          <input id="admin-soc-email" type="email" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);">
        </label>
        <label>Téléphone
          <input id="admin-soc-tel" type="tel" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);">
        </label>
        <label>Type de societe
          <select id="admin-soc-type" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);background:rgba(255,255,255,0.03);">
            <option value="">Choisir...</option>
            <option>Menage</option>
            <option>Deratisation / Desinsectisation</option>
            <option>Secu incendie</option>
            <option>Ascensoriste</option>
            <option>Espaces verts</option>
            <option>Autre</option>
          </select>
        </label>
        <label>Remise %
          <input id="admin-remise-pct" type="number" min="0" max="100" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);">
        </label>
        <label>Remise (mois)
          <input id="admin-remise-mois" type="number" min="0" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);">
        </label>
        <label style="grid-column:1/-1;display:flex;align-items:center;gap:10px;">
          <input type="checkbox" id="admin-essaie" style="width:18px;height:18px;"> Essai 30 jours (2 clients, 5 contrats, 5 employes)
        </label>
      </div>
      <h4 style="margin:18px 0 8px 0;">Contact principal</h4>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
        <label>Statut<input id="admin-contact-statut" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);"></label>
        <label>Prenom<input id="admin-contact-prenom" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);"></label>
        <label>Nom<input id="admin-contact-nom" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);"></label>
        <label>Email<input id="admin-contact-email" type="email" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);"></label>
        <label>Téléphone<input id="admin-contact-tel" type="tel" class="glass" style="margin-top:6px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);color:var(--text);"></label>
      </div>
      <div style="margin-top:16px;display:flex;gap:12px;justify-content:flex-end;">
        <button id="admin-soc-cancel" class="btn" style="background:rgba(255,255,255,0.08);color:var(--muted);">Annuler</button>
        <button id="admin-soc-save" class="btn btn-primary">Enregistrer (simulation)</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://wirwhmoxndqvlopzvgtf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndpcndobW94bmRxdmxvcHp2Z3RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NDMzNjksImV4cCI6MjA4MDAxOTM2OX0.Xp0PuJkglDYoWDq39_d6TuYdDX6ktJ9iJ1TSP2yT5Yc';
    const SOCIETE_BUCKET = 'societe-assets';
    const ALLOWED_EMAILS = ['nessalyspro@gmail.com'];
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const tabs = document.querySelectorAll('.tabs button');
    const contents = document.querySelectorAll('.content');
    const emailLabel = document.getElementById('admin-email');
    const roleLabel = document.getElementById('role-label');
    const accessDenied = document.getElementById('access-denied');
    const socList = document.getElementById('admin-societes-list');
    const siretMessage = document.getElementById('admin-siret-feedback');
    const logoPreview = document.getElementById('admin-logo-preview');
    const logoInput = document.getElementById('admin-soc-logo-file');

    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.dataset.tab;
        contents.forEach(c => c.classList.remove('active'));
        document.getElementById(target)?.classList.add('active');
      });
    });

    const updateSiretMessage = (message, tone = 'muted') => {
      if (!siretMessage) return;
      const colors = { success: '#86efac', error: '#fca5a5', muted: '#94a3b8' };
      siretMessage.textContent = message || '';
      siretMessage.style.color = colors[tone] || colors.muted;
    };

    const normalizeSiret = (value = '') => value.replace(/\D/g, '');

    const buildAddressFromSirene = (etablissement) => {
      if (!etablissement) return '';
      const adr = etablissement.adresseEtablissement || {};
      const voie = [
        adr.numeroVoieEtablissement,
        adr.indiceRepetitionEtablissement,
        adr.typeVoieEtablissement,
        adr.libelleVoieEtablissement
      ].filter(Boolean).join(' ').replace(/\s+/g, ' ').trim();
      const postal = adr.codePostalEtablissement;
      const city = adr.libelleCommuneEtablissement || adr.libelleCedexEtablissement;
      return [voie, postal, city].filter(Boolean).join(' ');
    };

    const fetchSiret = async (value, showFeedback = true) => {
      const normalized = normalizeSiret(value);
      if (!normalized) {
        if (showFeedback) updateSiretMessage('', 'muted');
        return null;
      }
      if (normalized.length !== 14) {
        if (showFeedback) updateSiretMessage('14 chiffres requis', 'error');
        return null;
      }
      if (showFeedback) updateSiretMessage('Vérification officielle...', 'muted');
      try {
        const response = await fetch(`https://entreprise.data.gouv.fr/api/sirene/v3/etablissements/${normalized}`);
        if (!response.ok) {
          if (showFeedback) updateSiretMessage('SIRET introuvable', 'error');
          return null;
        }
        const data = await response.json();
        if (showFeedback) updateSiretMessage('SIRET vérifié', 'success');
        return data;
      } catch (error) {
        console.error('Erreur API SIRET', error);
        if (showFeedback) updateSiretMessage('Service indisponible', 'error');
        return null;
      }
    };

    const handleSiretBlur = async () => {
      const input = document.getElementById('admin-soc-siret');
      if (!input) return null;
      const payload = await fetchSiret(input.value, true);
      if (payload) {
        const formatted = buildAddressFromSirene(payload.etablissement);
        const addrInput = document.getElementById('admin-soc-adresse');
        if (formatted && addrInput && !addrInput.value) {
          addrInput.value = formatted;
        }
      }
      return payload;
    };

    document.getElementById('admin-soc-siret')?.addEventListener('blur', handleSiretBlur);

    logoInput?.addEventListener('change', () => {
      if (!logoPreview) return;
      const file = logoInput.files?.[0];
      if (!file) {
        logoPreview.style.backgroundImage = '';
        logoPreview.textContent = 'Logo';
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        logoPreview.style.backgroundImage = `url('${reader.result}')`;
        logoPreview.style.backgroundSize = 'cover';
        logoPreview.style.backgroundPosition = 'center';
        logoPreview.textContent = '';
      };
      reader.readAsDataURL(file);
    });

    const renderSocietes = (rows = []) => {
      if (!socList) return;
      if (!rows.length) {
        socList.innerHTML = '<div class="glass card" style="padding:12px;border-radius:14px;"><p style="margin:0;color:var(--muted);">Aucune société enregistrée.</p></div>';
        return;
      }
      socList.innerHTML = rows.map(row => {
        const initials = (row.name || 'S').split(' ').filter(Boolean).map(word => word[0]).join('').slice(0, 2).toUpperCase();
        const safeLogo = row.logo_public_url ? row.logo_public_url.replace(/"/g, '%22') : '';
        const logoCss = row.logo_public_url
          ? `background-image:url("${safeLogo}");background-size:cover;background-position:center;`
          : 'background:rgba(255,255,255,0.08);color:var(--muted);display:flex;align-items:center;justify-content:center;font-weight:700;';
        const created = row.created_at ? new Date(row.created_at).toLocaleDateString('fr-FR') : '-';
        const badge = row.trial_enabled
          ? '<span class="chip danger">Essai 30j</span>'
          : '<span class="chip">Actif</span>';
        return `
        <div class="glass card" style="padding:14px;border-radius:16px;display:flex;flex-direction:column;gap:10px;">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:48px;height:48px;border-radius:12px;${logoCss}">${row.logo_public_url ? '' : initials}</div>
            <div style="flex:1;">
              <p style="margin:0;font-weight:700;">${row.name || 'Sans nom'}</p>
              <p style="margin:2px 0 0 0;font-size:12px;color:var(--muted);">${row.ref || '-'}</p>
            </div>
            ${badge}
          </div>
          <div style="display:flex;justify-content:space-between;flex-wrap:wrap;font-size:12px;color:var(--muted);gap:8px;">
            <span>${row.type_activite || 'Type non défini'}</span>
            <span>${created}</span>
          </div>
        </div>`;
      }).join('');
    };

    const loadSocietes = async () => {
      if (!socList) return;
      socList.innerHTML = '<div class="glass card" style="padding:12px;border-radius:14px;"><p style="margin:0;color:var(--muted);">Chargement...</p></div>';
      const { data, error } = await supabaseClient
        .from('societes')
        .select('id,ref,name,type_activite,status,trial_enabled,logo_public_url,created_at')
        .order('created_at', { ascending: false });
      if (error) {
        socList.innerHTML = `<div class="glass card" style="padding:12px;border-radius:14px;"><p style="margin:0;color:#fda4af;">${error.message}</p></div>`;
        return;
      }
      renderSocietes(data || []);
    };

    const uploadLogo = async (file, ref) => {
      if (!file) return { path: null, url: null };
      const extension = (file.name.split('.').pop() || 'png').toLowerCase();
      const path = `logos/${ref}/${Date.now()}.${extension}`;
      const { error } = await supabaseClient.storage.from(SOCIETE_BUCKET).upload(path, file, {
        cacheControl: '3600',
        upsert: true
      });
      if (error) throw new Error(`Upload logo impossible : ${error.message}`);
      const { data } = supabaseClient.storage.from(SOCIETE_BUCKET).getPublicUrl(path);
      return { path, url: data?.publicUrl || null };
    };

    const setModalLoading = (loading) => {
      const btn = document.getElementById('admin-soc-save');
      if (!btn) return;
      btn.disabled = loading;
      btn.textContent = loading ? 'Enregistrement...' : 'Enregistrer';
    };

    const collectSocietePayload = () => {
      const getVal = (id) => document.getElementById(id)?.value?.trim() || '';
      const trial = document.getElementById('admin-essaie')?.checked || false;
      const now = new Date();
      const contact = {
        role_label: getVal('admin-contact-statut'),
        first_name: getVal('admin-contact-prenom'),
        last_name: getVal('admin-contact-nom'),
        email: getVal('admin-contact-email'),
        phone: getVal('admin-contact-tel')
      };
      const hasContact = Object.values(contact).some(Boolean);
      return {
        ref: getVal('admin-soc-ref'),
        name: getVal('admin-soc-nom'),
        siret: normalizeSiret(getVal('admin-soc-siret')),
        address: getVal('admin-soc-adresse'),
        email: getVal('admin-soc-email'),
        phone: getVal('admin-soc-tel'),
        type: document.getElementById('admin-soc-type')?.value || '',
        remisePercent: parseFloat(getVal('admin-remise-pct')) || null,
        remiseMois: parseInt(getVal('admin-remise-mois'), 10) || null,
        trialEnabled: trial,
        trialStartedAt: trial ? now.toISOString() : null,
        trialExpiresAt: trial ? new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString() : null,
        contact: hasContact ? contact : null,
        logoFile: logoInput?.files?.[0] || null
      };
    };

    const saveSociete = async () => {
      const payload = collectSocietePayload();
      if (!payload.name) {
        alert('Nom requis');
        return;
      }
      if (payload.siret.length !== 14) {
        alert('Le SIRET doit contenir 14 chiffres');
        return;
      }
      setModalLoading(true);
      try {
        const sirene = await fetchSiret(payload.siret, false);
        if (!sirene) throw new Error('Impossible de vérifier le SIRET');
        const formatted = buildAddressFromSirene(sirene.etablissement);
        if (formatted && !payload.address) {
          document.getElementById('admin-soc-adresse').value = formatted;
          payload.address = formatted;
        }
        const logoInfo = await uploadLogo(payload.logoFile, payload.ref);
        const { data: created, error } = await supabaseClient.from('societes').insert([{
          ref: payload.ref,
          name: payload.name,
          siret: payload.siret,
          address_line1: payload.address || null,
          email: payload.email || null,
          phone: payload.phone || null,
          type_activite: payload.type || null,
          remise_percent: payload.remisePercent,
          remise_mois: payload.remiseMois,
          trial_enabled: payload.trialEnabled,
          trial_started_at: payload.trialStartedAt,
          trial_expires_at: payload.trialExpiresAt,
          base_price_ht: 29.99,
          logo_storage_path: logoInfo.path,
          logo_public_url: logoInfo.url
        }]).select().single();
        if (error) throw error;
        if (payload.contact) {
          await supabaseClient.from('societe_contacts').insert([{ ...payload.contact, societe_id: created.id }]);
        }
        await supabaseClient.from('societe_limits').upsert({
          societe_id: created.id,
          clients_limit: payload.trialEnabled ? 2 : null,
          contracts_limit: payload.trialEnabled ? 5 : null,
          employees_limit: payload.trialEnabled ? 5 : null
        }, { onConflict: 'societe_id' });
        alert('Société créée');
        closeSocModal();
        loadSocietes();
      } catch (err) {
        console.error(err);
        alert(err.message || 'Erreur lors de la création');
      } finally {
        setModalLoading(false);
      }
    };

    document.getElementById('logout-btn').addEventListener('click', async () => {
      await supabaseClient.auth.signOut();
      window.location.href = 'Accueil.html#admin-login';
    });

    const socModal = document.getElementById('admin-societe-modal');
    const openSocModal = () => {
      const ref = `SCT-${Date.now().toString().slice(-6)}`;
      document.getElementById('admin-soc-ref').value = ref;
      document.getElementById('admin-soc-ref-label').textContent = `Ref: ${ref}`;
      ['admin-soc-nom','admin-soc-siret','admin-soc-adresse','admin-soc-email','admin-soc-tel','admin-soc-type','admin-remise-pct','admin-remise-mois','admin-contact-statut','admin-contact-prenom','admin-contact-nom','admin-contact-email','admin-contact-tel'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      const checkbox = document.getElementById('admin-essaie');
      if (checkbox) checkbox.checked = false;
      if (logoInput) logoInput.value = '';
      if (logoPreview) {
        logoPreview.style.backgroundImage = '';
        logoPreview.textContent = 'Logo';
      }
      updateSiretMessage('', 'muted');
      socModal.style.display = 'flex';
    };
    const closeSocModal = () => {
      if (socModal) socModal.style.display = 'none';
    };
    document.getElementById('admin-create-societe')?.addEventListener('click', openSocModal);
    document.getElementById('admin-close-societe')?.addEventListener('click', closeSocModal);
    document.getElementById('admin-soc-cancel')?.addEventListener('click', closeSocModal);
    document.getElementById('admin-soc-save')?.addEventListener('click', saveSociete);

    async function guard() {
      const { data, error } = await supabaseClient.auth.getSession();
      if (error || !data?.session) {
        window.location.href = 'Accueil.html#admin-login';
        return;
      }
      const user = data.session.user;
      emailLabel.textContent = user.email || '-';
      roleLabel.textContent = user.role || 'Admin';
      if (!ALLOWED_EMAILS.includes(user.email)) {
        accessDenied.style.display = 'block';
        contents.forEach(c => c.classList.remove('active'));
        tabs.forEach(b => b.disabled = true);
        return;
      }
      loadSocietes();
    }

    guard();
  </script>
</body>
</html>
